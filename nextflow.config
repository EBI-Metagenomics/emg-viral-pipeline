manifest {
    mainScript = 'virify.nf'
    nextflowVersion = '>=20.00.0'
}

params {
    max_cores            = Runtime.runtime.availableProcessors()
    cores                = Runtime.runtime.availableProcessors().intdiv(4)
    memory               = 12
    help                 = false

    // inputs
    assemble             = ''
    fasta                = ''
    samplesheet          = ''

    // databases
    virsorter            = false
    virsorter2           = false
    virfinder            = false
    viphog               = false
    ncbi                 = false
    checkv               = false
    rvdb                 = false
    pvogs                = false
    vogdb                = false
    vpf                  = false
    imgvr                = false
    pprmeta              = false
    meta                 = false

    virome               = false
    hmmextend            = false
    blastextend          = false
    chromomap            = false
    balloon              = false
    onlyannotate         = false
    use_virsorter_v1     = false
    mashmap_len          = 2000
    mashmap              = ''
    evalue               = 0.01
    prop                 = 0.1
    taxthres             = 0.6
    factor               = "$projectDir/references/viphogs_cds_per_taxon_cummulative.csv"

    sankey               = 25
    chunk                = 10
    length               = 1.5 // in kb, so 0.5 filters all contigs shorter 500 nt

    // development
    viphog_version       = 'v3'
    meta_version         = 'v4'

    // folder structure
    output               = 'results'
    assemblydir          = '00-assembly'
    virusdir             = '01-viruses'
    prodigaldir          = '02-prodigal'
    phanotatedir         = '02-phanotate'
    hmmerdir             = '03-hmmer'
    blastdir             = '04-blast'
    plotdir              = '05-plots'
    taxdir               = '06-taxonomy'
    checkvdir            = '07-checkv'
    finaldir             = '08-final'

    // location for autodownload data like databases
    databases            = 'nextflow-autodownload-databases'

    // optional profile configurations, mostly necessary for HPC execution [lsf, slurm]
    workdir              = 'work'
    singularity_cachedir = 'singularity'
    
    publish_dir_mode     = 'copy'
    
    // MultiQC options
    multiqc_config             = null
    multiqc_title              = null
    multiqc_logo               = null
    multiqc_methods_description = null
    
    // Max resource options
    // Defaults only, expecting to be overwritten
    max_memory                       = '1.TB'
    max_cpus                         = 32
    max_time                         = '168.h' // 7 days
}

includeConfig 'configs/base.config'
includeConfig 'configs/modules.config'

profiles {

    //executors
    local {
        executor {
                name = "local"
               	cpus = params.max_cores
        } 
        workDir = params.workdir
        params.cloudProcess = false
        includeConfig 'configs/local.config'
    }

    lsf {
        workDir = params.workdir
        executor {
            name = "lsf"
            queueSize = 200
        }        
        params.cloudProcess = true
        process.cache = "lenient"
    }

    slurm {
        workDir = params.workdir
        executor {
            name = "slurm"
            queueSize = 200
        }        
        params.cloudProcess = true
        process.cache = "lenient"
    }

    
    //engines
    docker { 
        docker { enabled = true }
    }

    singularity {
        singularity { 
                enabled = true
                autoMounts = true
                cacheDir = params.singularity_cachedir
        }
    }

    conda { 
        // not working right now due to missing conda package for PPR-Meta! 
        includeConfig 'configs/conda.config'
    }


    //pre-merged profiles for direct usage
    standard { 
        executor {
                name = "local"
               	cpus = params.max_cores
        }
        workDir = params.workdir
        params.cloudProcess = false
        includeConfig 'configs/local.config'
        docker { enabled = true }
    }

    ebi {
  	    params.workdir = "/hps/nobackup/rdf/metagenomics/service-team/nextflow-workdir/virify/"
  	    params.databases = "/hps/nobackup/rdf/metagenomics/service-team/ref-dbs/virify/"
  	    params.singularity_cachedir = "/hps/nobackup/rdf/metagenomics/service-team/singularity-cache/"

        workDir = params.workdir
     
        params.cloudProcess = true
        process.cache = "lenient"

        singularity { 
                enabled = true
                autoMounts = true
                cacheDir = params.singularity_cachedir
        }
    }

    // CONFIGURE YOUR PRIVATE CLOUD
    gcloud {
        workDir = params.workdir
        params.databases = 'gs://databases-matrice/virify/'
        bucketDir = 'gs://matrice/virify-work'

        process.executor = 'google-lifesciences'
 
        google {
            project = 'nextflow-auto-255816'
            zone = 'europe-west1-b'
            lifeSciences.preemptible = false
            lifeSciences.bootDiskSize = 20.GB
        }

        params.cloudProcess = true

        docker { enabled = true }
    }
} 

def check_max(obj, type) {
    if (type == 'memory') {
        try {
            if (obj.compareTo(params.max_memory as nextflow.util.MemoryUnit) == 1)
                return params.max_memory as nextflow.util.MemoryUnit
            else
                return obj
        } catch (all) {
            println "   ### ERROR ###   Max memory '${params.max_memory}' is not valid! Using default value: $obj"
            return obj
        }
    } else if (type == 'time') {
        try {
            if (obj.compareTo(params.max_time as nextflow.util.Duration) == 1)
                return params.max_time as nextflow.util.Duration
            else
                return obj
        } catch (all) {
            println "   ### ERROR ###   Max time '${params.max_time}' is not valid! Using default value: $obj"
            return obj
        }
    } else if (type == 'cpus') {
        try {
            return Math.min( obj, params.max_cpus as int )
        } catch (all) {
            println "   ### ERROR ###   Max cpus '${params.max_cpus}' is not valid! Using default value: $obj"
            return obj
        }
    }
}
